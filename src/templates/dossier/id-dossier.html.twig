{% extends 'base.html.twig' %}

{% block title %}dossier
	{{ dossier.nom_produit }}
{% endblock %}

{% block body %}
	<div class="container">
		{% include 'components/connected-as.html.twig' %}

		<nav aria-label="breadcrumb bg-white">
			<ol class="breadcrumb bg-light p-2 px-3 rounded">
				<li class="breadcrumb-item">
					<a href="/">Accueil</a>
				</li>
				{% if isAdmin %}
					<li class="breadcrumb-item">
						<a title="Commercial #{{ commercial.id_personne }}" href="/admin/co/{{ commercial.id_personne }}" class="fw-bold">{% include 'components/titre-personne.html.twig' with { personne: commercial} %} (commercial)</a>
					</li>
				{% endif %}
				<li class="breadcrumb-item">
					<a title="Client #{{ client.id_personne }}" href="/cl/{{ client.id_personne }}" class="fw-bold">{% include 'components/titre-personne.html.twig' with { personne: client} %} (client)</a>
				</li>
				<li class="breadcrumb-item active">«&nbsp;{{ dossier.nom_produit }}&nbsp;» (Dossier #{{ dossier.id_dossier }})</li>
			</ol>
		</nav>

		<!-- Titre du produit -->
		<div class="mb-4">
			<div>
				<h4 class="mb-0 mt-3">Dossier #{{ dossier.id_dossier }}, «
					{{ dossier.nom_produit }}
					»</h4>
				<p class="text-muted">Ce produit est fourni par «
					{% if isAdmin %}
						<a href="/admin/f/{{ fournisseur.id_personne }}">
						{% endif %}
						{% include 'components/titre-personne.html.twig' with { personne: fournisseur} %}
						{% if isAdmin %}
						</a>
					{% endif %}
					»</p>
			</div>
		</div>

		<!-- Etats dossier -->
		{% if etats|length > 0 %}
			<form action="{{ currentUrl }}/changer-etat" method="post">
				<select name="etat" class="form-select d-inline-block w-auto me-3">
					{% for etat in etats %}
						<option value="{{ etat.id_etat }}" {{ etat.id_etat == dossier.etat_dossier ? ' selected' : ''}}>{{ etat.description}}</option>
					{% endfor %}
				</select>
				<button class="btn btn-outline-primary my-1">Sauvegarder état du projet</button>
			</form>
		{% endif %}

		<h4 class="my-3">Fichiers</h4>
		<!-- Upload -->
		<form action="{{currentUrl}}/new-fichier" class="dropzone mb-3" id="dropzoneForm">
			<span class="dz-message">
				<i class="material-icons">add</i>
				Ajouter des fichiers</span>
		</form>
		<a href="{{currentUrl}}/new-fichier" class="d-block mb-3">
			<i>(ou si vous avez des difficultés pour uploader, essayez ce lien à la place)</i>
		</a>

		<!-- Fichiers -->
		<div class="mb-3">
			{% if fichiers|length > 0 %}
				<a href="{{ currentUrl }}/zip" class="btn btn-primary me-2 mb-2">
					<i class="material-icons">download</i>
					Télécharger tous les fichiers ci dessous</a>
			{% endif %}
			<a href="{{ currentUrl }}/corbeille" class="btn btn-outline-secondary mb-2">
				<i class="material-icons">delete</i>
				Accéder à la corbeille</a>
		</div>

		<!-- LISTE COMBINÉE DES FICHIERS ET LOGS -->
		<div class="row">
			{% for eventGroup in events %}
				{% for event in eventGroup %}
					{% if event.type == 'fichier' %}
						{% include "components/fichier.html.twig" with { fichier: event.object } %}
					{% else %}
						{% set log = event.object %}
						<div>
							<div class="card mb-3">
								<div class="card-body">
									<strong class="d-block">{{ log.nom_action }}</strong>
									{{ log.date_heure|timeago }}
									<small class="text-muted">({{ log.date_heure }})</small>
									par
									{% include 'components/titre-personne.html.twig' with { personne: log} %}
									<small class="d-block text-muted">{{ log.desc_action }}</small>
								</div>
							</div>
						</div>
					{% endif %}
				{% endfor %}
			{% endfor %}
		</div>
	</div>
{% endblock %}
